name: Veracode Scan

on: [push, pull_request]

env:
  JAVA_WRAPPER_VERSION: "20.3.6.1" # Update the version when new version is released.
  APP_NAME: "Veracode Jenkins Plugin"
  SANDBOX_NAME: "GitHub Open Source Sandbox"

jobs:
  scan:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2
    
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    
    - name: Build with Maven
      run: mvn -B package --file pom.xml
  
    - name: Trigger Test Automation
      uses: SvanBoxel/gitlab-mirror-and-ci-action@master
      with:
        args: "https://gitlab.laputa.veracode.io/Integrations-Development/automation-test/jenkins-automation"
      env:
        GITLAB_HOSTNAME: "gitlab.laputa.veracode.io"
        GITLAB_USERNAME: "pmathur"
        GITLAB_PASSWORD: ${{ secrets.GITLAB_PRIVATE_TOKEN }}
        GITLAB_PROJECT_ID: "2348"
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #run: "curl -X POST -F ref=master https://gitlab.laputa.veracode.io/api/v4/projects/2348/trigger/pipeline??private_token=${{ secrets.GITLAB_TOKEN }}"
    
    - name: Download Java Wrapper
      run: |
        echo 'Java Wrapper Version - '"${{ env.JAVA_WRAPPER_VERSION }}"
        curl https://repo1.maven.org/maven2/com/veracode/vosp/api/wrappers/vosp-api-wrappers-java/"${{ env.JAVA_WRAPPER_VERSION }}"/vosp-api-wrappers-java-"${{ env.JAVA_WRAPPER_VERSION }}".jar -o VeracodeJavaAPI.jar
    
    - name: Scan with Java Wrapper
      run: java -jar VeracodeJavaAPI.jar -vid ${{ secrets.VERACODE_API_ID }} -vkey ${{ secrets.VERACODE_API_KEY }} -action UploadAndScan -appname "${{ env.APP_NAME }}" -createprofile true -sandboxname "${{ env.SANDBOX_NAME }}" -createsandbox true -filepath target/veracode-scan.jar -version "$(date +'%Y-%m-%d-%H:%M:%S')" 
